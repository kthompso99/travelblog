<script src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_MAPS_API_KEY}}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const locations = {{LOCATIONS_JSON}};
        let map;

        try {
            console.log('Initializing trip map...');

            // Calculate center
            const lats = locations.map(l => l.coordinates.lat);
            const lngs = locations.map(l => l.coordinates.lng);
            const centerLat = (Math.min(...lats) + Math.max(...lats)) / 2;
            const centerLng = (Math.min(...lngs) + Math.max(...lngs)) / 2;

            map = new google.maps.Map(document.getElementById('trip-map-full'), {
                center: { lat: centerLat, lng: centerLng },
                zoom: 8,
                mapTypeId: 'roadmap',
                zoomControl: true,
                mapTypeControl: true,
                streetViewControl: false,
                fullscreenControl: true,
                styles: {{MAP_STYLES}}
            });
            console.log('Trip map instance created');
        } catch (error) {
            console.error('Error initializing trip map:', error);
            const mapContainer = document.getElementById('trip-map-full');
            if (mapContainer) {
                mapContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #dc2626;"><h3>Map Error</h3><p>' + error.message + '</p></div>';
            }
            return;
        }

        const bounds = new google.maps.LatLngBounds();
        const HOVER_LINGER_MS = 300;

        let hoverTimeout = null;

        try {
            // Helper to create numbered marker icon
            function createNumberedIcon(number, highlighted) {
                const outerRadius = highlighted ? 20 : 18;
                const shadow = highlighted
                    ? '<circle cx="21" cy="23" r="' + outerRadius + '" fill="rgba(0,0,0,0.18)"/>'
                    : '<circle cx="21" cy="23" r="' + outerRadius + '" fill="rgba(0,0,0,0.12)"/>';
                var inner;
                if (highlighted) {
                    // Solid amber circle with white number (matches sidebar highlight)
                    inner = '<circle cx="21" cy="21" r="' + outerRadius + '" fill="#d97706" stroke="white" stroke-width="3"/>' +
                        '<text x="21" y="21" text-anchor="middle" dy=".35em" font-family="Arial, sans-serif" font-size="14" font-weight="700" fill="white">' + number + '</text>';
                } else {
                    // White circle with amber ring and amber number
                    inner = '<circle cx="21" cy="21" r="' + outerRadius + '" fill="#f59e0b"/>' +
                        '<circle cx="21" cy="21" r="' + (outerRadius - 3) + '" fill="white" stroke="#f59e0b" stroke-width="3"/>' +
                        '<text x="21" y="21" text-anchor="middle" dy=".35em" font-family="Arial, sans-serif" font-size="14" font-weight="700" fill="#f59e0b">' + number + '</text>';
                }
                const svg = '<svg width="44" height="46" viewBox="0 0 44 46" xmlns="http://www.w3.org/2000/svg">' +
                    shadow + inner + '</svg>';
                return {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
                    scaledSize: new google.maps.Size(44, 46),
                    anchor: new google.maps.Point(21, 21)
                };
            }

            // Create single shared InfoWindow
            const infoWindow = new google.maps.InfoWindow({
                pixelOffset: new google.maps.Size(0, -32),
                disableAutoPan: true
            });

            let mouseOverInfoWindow = false;

            google.maps.event.addListener(infoWindow, 'domready', () => {
                const iwOuter = document.querySelector('.gm-style-iw-c');
                if (iwOuter) {
                    iwOuter.addEventListener('mouseenter', () => {
                        mouseOverInfoWindow = true;
                        if (hoverTimeout) clearTimeout(hoverTimeout);
                    });
                    iwOuter.addEventListener('mouseleave', () => {
                        mouseOverInfoWindow = false;
                        hoverTimeout = setTimeout(() => infoWindow.close(), HOVER_LINGER_MS);
                    });
                    // Wire custom close button
                    var closeBtn = iwOuter.querySelector('.popup-close-btn');
                    if (closeBtn) {
                        closeBtn.onclick = function() { infoWindow.close(); };
                    }
                }
            });

            // Build popup HTML for a location card
            function buildPopupHtml(loc, stopNumber) {
                var imageHtml = '';
                if (loc.thumbnail) {
                    imageHtml = '<div class="popup-image-wrapper">' +
                        '<img src="' + loc.thumbnail + '" alt="' + loc.title + '" onerror="this.parentNode.remove()">' +
                        '<div class="popup-stop-badge">Stop ' + stopNumber + '</div>' +
                    '</div>';
                }
                var metaHtml = '';
                if (loc.duration) {
                    metaHtml = '<div class="popup-meta"><span class="popup-duration">\uD83D\uDD50 ' + loc.duration + '</span></div>';
                }
                var arrowSvg = '<svg width="14" height="14" viewBox="0 0 16 16"><path d="M8 0L6.59 1.41 12.17 7H0v2h12.17l-5.58 5.59L8 16l8-8z" fill="currentColor"/></svg>';
                return '<div class="map-popup-card">' +
                    '<button class="popup-close-btn" type="button">\u00D7</button>' +
                    imageHtml +
                    '<div class="popup-content">' +
                        '<h3 class="popup-title">' + loc.title + '</h3>' +
                        metaHtml +
                        '<a href="./' + loc.slug + '.html" class="popup-link">View Details ' + arrowSvg + '</a>' +
                    '</div>' +
                '</div>';
            }

            // Create numbered markers
            const markers = [];  // Store markers for cross-reference with sidebar

            locations.forEach((loc, idx) => {
                const position = { lat: loc.coordinates.lat, lng: loc.coordinates.lng };
                bounds.extend(position);

                const marker = new google.maps.Marker({
                    map: map,
                    position: position,
                    icon: createNumberedIcon(idx + 1, false),
                    title: loc.title,
                    cursor: 'pointer'
                });

                // Store location index on marker for identification
                marker.locationIndex = idx + 1;
                markers.push(marker);

                const content = buildPopupHtml(loc, idx + 1);

                let infoWindowOpen = false;

                marker.addListener('mouseover', () => {
                    if (hoverTimeout) clearTimeout(hoverTimeout);
                    mouseOverInfoWindow = false;
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                    infoWindowOpen = true;

                    // Highlight marker itself
                    marker.setIcon(createNumberedIcon(idx + 1, true));

                    // Highlight corresponding sidebar item and scroll it into view
                    const sidebarItem = document.querySelector('[data-location-index="' + marker.locationIndex + '"]');
                    if (sidebarItem) {
                        sidebarItem.classList.add('highlighted');
                        sidebarItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });

                marker.addListener('mouseout', () => {
                    hoverTimeout = setTimeout(() => {
                        if (!mouseOverInfoWindow) {
                            infoWindow.close();
                            infoWindowOpen = false;
                        }
                    }, HOVER_LINGER_MS);

                    // Restore marker icon
                    marker.setIcon(createNumberedIcon(idx + 1, false));

                    // Remove highlight from sidebar item
                    const sidebarItem = document.querySelector('[data-location-index="' + marker.locationIndex + '"]');
                    if (sidebarItem) {
                        sidebarItem.classList.remove('highlighted');
                    }
                });

                marker.addListener('click', () => {
                    // On mobile: first tap opens InfoWindow, second tap navigates
                    if (!infoWindowOpen) {
                        if (hoverTimeout) clearTimeout(hoverTimeout);
                        mouseOverInfoWindow = false;
                        infoWindow.setContent(content);
                        infoWindow.open(map, marker);
                        infoWindowOpen = true;
                    } else {
                        window.location.href = './' + loc.slug + '.html';
                    }
                });
            });

            // Add sidebar hover listeners to highlight corresponding markers
            document.querySelectorAll('.location-list-item').forEach(function(item) {
                const locationIndex = parseInt(item.getAttribute('data-location-index'));
                const correspondingMarker = markers.find(function(m) { return m.locationIndex === locationIndex; });

                if (correspondingMarker) {
                    item.addEventListener('mouseenter', function() {
                        // Highlight marker icon
                        correspondingMarker.setIcon(createNumberedIcon(locationIndex, true));
                    });

                    item.addEventListener('mouseleave', function() {
                        // Restore normal marker icon
                        correspondingMarker.setIcon(createNumberedIcon(locationIndex, false));
                    });
                }
            });

            // Add per-segment polylines connecting locations
            var routeSegments = [];
            for (var s = 0; s < locations.length - 1; s++) {
                var segPath = [
                    { lat: locations[s].coordinates.lat, lng: locations[s].coordinates.lng },
                    { lat: locations[s + 1].coordinates.lat, lng: locations[s + 1].coordinates.lng }
                ];
                var seg = new google.maps.Polyline({
                    path: segPath,
                    geodesic: true,
                    strokeColor: '#e8a317',
                    strokeOpacity: 0.85,
                    strokeWeight: 5,
                    icons: [{
                        icon: { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 4 },
                        offset: '0',
                        repeat: '20px'
                    }]
                });
                seg.setMap(map);
                routeSegments.push(seg);
            }

            function setSegmentStyle(seg, color, opacity, weight) {
                seg.setOptions({ strokeColor: color, strokeOpacity: opacity, strokeWeight: weight });
            }

            function resetAllSegments() {
                routeSegments.forEach(function(seg) {
                    setSegmentStyle(seg, '#e8a317', 0.85, 5);
                });
            }

            function updateSegmentsForStep(stepIdx) {
                routeSegments.forEach(function(seg, i) {
                    if (i < stepIdx) {
                        // Traveled: bold amber
                        setSegmentStyle(seg, '#e8a317', 0.85, 5);
                    } else {
                        // Future: muted gray
                        setSegmentStyle(seg, '#94a3b8', 0.6, 3);
                    }
                });
            }

            // Fit map to show all markers
            map.fitBounds(bounds, { padding: 50 });

            // ─── "Follow the Journey" auto-play ───
            var playBtn = document.getElementById('play-trip-btn');
            var stopBtn = document.getElementById('stop-trip-btn');
            var tourControls = playBtn ? playBtn.closest('.tour-controls') : null;
            var playTimer = null;
            var playIndex = 0;
            var playState = 'stopped'; // 'stopped' | 'playing' | 'paused'
            var STEP_DURATION_MS = 3500;
            var savedBounds = null;

            function clearAllHighlights() {
                markers.forEach(function(m, i) {
                    m.setIcon(createNumberedIcon(i + 1, false));
                });
                document.querySelectorAll('.location-list-item').forEach(function(el) {
                    el.classList.remove('highlighted', 'traveled', 'future');
                });
                document.querySelectorAll('.travel-segment').forEach(function(el) {
                    el.classList.remove('future-segment');
                });
                // Clear timeline-fade classes from all li elements
                document.querySelectorAll('.trip-map-locations-list li').forEach(function(el) {
                    el.classList.remove('step-future');
                });
                infoWindow.close();
            }

            function updateSidebarForStep(stepIdx) {
                var allItems = document.querySelectorAll('.location-list-item');
                var allSegments = document.querySelectorAll('.travel-segment');

                allItems.forEach(function(el) {
                    var idx = parseInt(el.getAttribute('data-location-index')) - 1;
                    var li = el.closest('li');
                    el.classList.remove('highlighted', 'traveled', 'future');
                    li.classList.remove('step-future');
                    if (idx < stepIdx) {
                        el.classList.add('traveled');
                    } else if (idx === stepIdx) {
                        el.classList.add('highlighted');
                    } else {
                        el.classList.add('future');
                        li.classList.add('step-future');
                    }
                });

                // Travel segments sit before their destination stop.
                // Segment at DOM index i connects stop i to stop i+1.
                allSegments.forEach(function(el, i) {
                    el.classList.remove('future-segment');
                    if (i >= stepIdx) {
                        el.classList.add('future-segment');
                    }
                });
            }

            function showStep(stepIdx) {
                // Reset marker icons and sidebar classes (but don't close InfoWindow)
                markers.forEach(function(m, i) {
                    m.setIcon(createNumberedIcon(i + 1, false));
                });
                document.querySelectorAll('.location-list-item').forEach(function(el) {
                    el.classList.remove('highlighted', 'traveled', 'future');
                });
                document.querySelectorAll('.travel-segment').forEach(function(el) {
                    el.classList.remove('future-segment');
                });
                document.querySelectorAll('.trip-map-locations-list li').forEach(function(el) {
                    el.classList.remove('step-future');
                });

                var loc = locations[stepIdx];
                var marker = markers[stepIdx];

                // Highlight marker
                marker.setIcon(createNumberedIcon(stepIdx + 1, true));

                // Pan map to location, then nudge viewport up so InfoWindow above marker is visible
                map.panTo(marker.getPosition());
                map.panBy(0, -100);

                // Highlight traveled segments on map, mute future ones
                updateSegmentsForStep(stepIdx);

                // Update sidebar: traveled / current / future
                updateSidebarForStep(stepIdx);

                // Fade out old card, then swap content and fade in new card
                var popupHtml = buildPopupHtml(loc, stepIdx + 1).replace('map-popup-card', 'map-popup-card popup-fade-in');
                var oldCard = document.querySelector('.map-popup-card');
                if (oldCard && stepIdx > 0) {
                    oldCard.classList.add('popup-fade-out');
                    setTimeout(function() {
                        infoWindow.setContent(popupHtml);
                        infoWindow.open(map, marker);
                    }, 250);
                } else {
                    infoWindow.setContent(popupHtml);
                    infoWindow.open(map, marker);
                }

                // Scroll next item into view so user can see what's coming
                var nextItem = document.querySelector('[data-location-index="' + (stepIdx + 2) + '"]');
                if (nextItem) {
                    nextItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    // Last stop — scroll current into view
                    var currentItem = document.querySelector('[data-location-index="' + (stepIdx + 1) + '"]');
                    if (currentItem) currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }

            function advanceStep() {
                playIndex++;
                if (playIndex >= locations.length) {
                    stopPlayback();
                    return;
                }
                showStep(playIndex);
            }

            function setBtnLabel(icon, text) {
                playBtn.innerHTML = '<span class="btn-icon">' + icon + '</span> ' + text;
            }

            function startPlayback() {
                if (playState === 'playing') return;
                playState = 'playing';
                playIndex = 0;
                savedBounds = map.getBounds();
                setBtnLabel('\u23F8', 'Pause Tour');
                playBtn.className = 'play-trip-btn playing';
                if (tourControls) tourControls.classList.add('active');
                // Scroll sidebar to top before starting
                var sidebar = document.querySelector('.trip-map-sidebar');
                if (sidebar) sidebar.scrollTop = 0;
                showStep(0);
                playTimer = setInterval(advanceStep, STEP_DURATION_MS);
            }

            function pausePlayback() {
                if (playState !== 'playing') return;
                playState = 'paused';
                if (playTimer) { clearInterval(playTimer); playTimer = null; }
                setBtnLabel('\u25B6', 'Resume Tour');
                playBtn.className = 'play-trip-btn paused';
            }

            function resumePlayback() {
                if (playState !== 'paused') return;
                playState = 'playing';
                setBtnLabel('\u23F8', 'Pause Tour');
                playBtn.className = 'play-trip-btn playing';
                playTimer = setInterval(advanceStep, STEP_DURATION_MS);
            }

            function stopPlayback() {
                playState = 'stopped';
                if (playTimer) { clearInterval(playTimer); playTimer = null; }
                setBtnLabel('\u25B6', 'Follow the Journey');
                playBtn.className = 'play-trip-btn';
                if (tourControls) tourControls.classList.remove('active');
                clearAllHighlights();
                resetAllSegments();
                // Restore original view
                if (savedBounds) {
                    map.fitBounds(savedBounds);
                    savedBounds = null;
                }
            }

            if (playBtn) {
                playBtn.addEventListener('click', function() {
                    if (playState === 'playing') {
                        pausePlayback();
                    } else if (playState === 'paused') {
                        resumePlayback();
                    } else {
                        startPlayback();
                    }
                });
            }

            if (stopBtn) {
                stopBtn.addEventListener('click', function() {
                    if (playState !== 'stopped') {
                        stopPlayback();
                    }
                });
            }

        } catch (error) {
            console.error('Error in trip map markers/polyline:', error);
        }
    });
</script>

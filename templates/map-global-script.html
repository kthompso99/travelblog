<script src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_MAPS_API_KEY}}"></script>

<script>
    let map = null;
    let markers = [];
    const config = {{MAP_CONFIG_JSON}};
    const APP_BASE = '/';

    function initMap() {
        try {
            console.log('Initializing Google Maps...');

            if (!map) {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 20, lng: 0 },
                    zoom: 2,
                    mapTypeId: 'roadmap',
                    zoomControl: true,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: true
                });
                console.log('Map instance created');
            }
        } catch (error) {
            console.error('Error initializing map:', error);
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #dc2626;"><h3>Map Error</h3><p>' + error.message + '</p><p style="font-size: 0.875rem; margin-top: 1rem;">Check browser console for details.</p></div>';
            }
            return;
        }

        markers.forEach(marker => marker.setMap(null));
        markers = [];

        // Amber teardrop icon (SVG data URI)
        function createTearDropIcon() {
            return {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                    '<svg width="24" height="36" viewBox="0 0 24 36" xmlns="http://www.w3.org/2000/svg">' +
                    '<path d="M12 0C5.373 0 0 5.373 0 12c0 9 12 24 12 24s12-15 12-24C24 5.373 18.627 0 12 0z" fill="#f59e0b"/>' +
                    '<circle cx="12" cy="12" r="5" fill="white"/>' +
                    '</svg>'
                ),
                scaledSize: new google.maps.Size(24, 36),
                anchor: new google.maps.Point(12, 36)
            };
        }

        // Numbered icon for location markers (used at high zoom)
        function createNumberedIcon(number, highlighted) {
            const bgColor = highlighted ? '#d97706' : '#f59e0b';
            const outerRadius = highlighted ? 18 : 16;
            const svg = '<svg width="38" height="38" viewBox="0 0 38 38" xmlns="http://www.w3.org/2000/svg">' +
                '<circle cx="19" cy="19" r="' + outerRadius + '" fill="' + bgColor + '"/>' +
                '<circle cx="19" cy="19" r="13" fill="white" stroke="' + bgColor + '" stroke-width="3"/>' +
                '<text x="19" y="19" text-anchor="middle" dy=".35em" font-family="Arial, sans-serif" font-size="14" font-weight="700" fill="' + bgColor + '">' + number + '</text>' +
                '</svg>';
            return {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
                scaledSize: new google.maps.Size(38, 38),
                anchor: new google.maps.Point(19, 19)
            };
        }

        // Create single shared InfoWindow for trip markers
        const tripInfoWindow = new google.maps.InfoWindow({
            pixelOffset: new google.maps.Size(0, -36)
        });

        // Create single shared InfoWindow for location markers
        const locationInfoWindow = new google.maps.InfoWindow({
            pixelOffset: new google.maps.Size(0, -32)
        });

        const HOVER_LINGER_MS = 300;

        let tripHoverTimeout = null;
        let locationHoverTimeout = null;
        let mouseOverTripInfoWindow = false;
        let mouseOverLocationInfoWindow = false;

        // Listen for trip InfoWindow DOM ready to attach hover listeners
        google.maps.event.addListener(tripInfoWindow, 'domready', () => {
            const iwOuter = document.querySelector('.gm-style-iw-c');
            if (iwOuter) {
                iwOuter.addEventListener('mouseenter', () => {
                    mouseOverTripInfoWindow = true;
                    if (tripHoverTimeout) clearTimeout(tripHoverTimeout);
                });
                iwOuter.addEventListener('mouseleave', () => {
                    mouseOverTripInfoWindow = false;
                    tripHoverTimeout = setTimeout(() => tripInfoWindow.close(), HOVER_LINGER_MS);
                });
            }
        });

        // Listen for location InfoWindow DOM ready to attach hover listeners
        google.maps.event.addListener(locationInfoWindow, 'domready', () => {
            const iwOuter = document.querySelector('.gm-style-iw-c');
            if (iwOuter) {
                iwOuter.addEventListener('mouseenter', () => {
                    mouseOverLocationInfoWindow = true;
                    if (locationHoverTimeout) clearTimeout(locationHoverTimeout);
                });
                iwOuter.addEventListener('mouseleave', () => {
                    mouseOverLocationInfoWindow = false;
                    locationHoverTimeout = setTimeout(() => locationInfoWindow.close(), HOVER_LINGER_MS);
                });
            }
        });

        // Track marker sets for zoom-based visibility
        const markerSets = [];

        config.trips.forEach(dest => {
            if (!dest.mapCenter || !dest.mapCenter.coordinates) return;

            const markerSet = {
                tripId: dest.slug,
                tripMarker: null,
                locationMarkers: [],
                polyline: null
            };

            // Create trip-level marker (teardrop)
            markerSet.tripMarker = new google.maps.Marker({
                map: map,
                position: {
                    lat: dest.mapCenter.coordinates.lat,
                    lng: dest.mapCenter.coordinates.lng
                },
                icon: createTearDropIcon(),
                title: dest.title
            });

            const tripContent = `
                <div class="marker-popup">
                    ${dest.thumbnail ? '<img src="' + dest.thumbnail + '" alt="' + dest.title + '" class="marker-popup-image" onerror="this.remove()">' : ''}
                    <div class="marker-popup-content">
                        <div class="marker-popup-title">${dest.title}</div>
                        <a href="../trips/${dest.slug}/" class="marker-popup-link">Read More â†’</a>
                    </div>
                </div>
            `;

            let tripInfoWindowOpen = false;

            markerSet.tripMarker.addListener('mouseover', () => {
                if (tripHoverTimeout) clearTimeout(tripHoverTimeout);
                mouseOverTripInfoWindow = false;
                tripInfoWindow.setContent(tripContent);
                tripInfoWindow.open(map, markerSet.tripMarker);
                tripInfoWindowOpen = true;
            });

            markerSet.tripMarker.addListener('mouseout', () => {
                tripHoverTimeout = setTimeout(() => {
                    if (!mouseOverTripInfoWindow) {
                        tripInfoWindow.close();
                        tripInfoWindowOpen = false;
                    }
                }, HOVER_LINGER_MS);
            });

            markerSet.tripMarker.addListener('click', () => {
                // On mobile: first tap opens InfoWindow, second tap navigates
                if (!tripInfoWindowOpen) {
                    if (tripHoverTimeout) clearTimeout(tripHoverTimeout);
                    mouseOverTripInfoWindow = false;
                    tripInfoWindow.setContent(tripContent);
                    tripInfoWindow.open(map, markerSet.tripMarker);
                    tripInfoWindowOpen = true;
                } else {
                    window.location.href = `../trips/${dest.slug}/`;
                }
            });

            markers.push(markerSet.tripMarker);

            // Create location-level markers (initially hidden)
            if (dest.locations && dest.locations.length > 0) {
                dest.locations.forEach((loc, idx) => {
                    const locationMarker = new google.maps.Marker({
                        position: loc.coordinates,
                        map: null,  // Initially not visible
                        icon: createNumberedIcon(idx + 1, false),
                        title: loc.name
                    });

                    // Generate slug from name (lowercase, replace spaces with hyphens)
                    const locationSlug = loc.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                    locationMarker.tripSlug = dest.slug;
                    locationMarker.locationSlug = locationSlug;

                    markerSet.locationMarkers.push(locationMarker);

                    // Build InfoWindow content to match trip map structure exactly
                    const thumbHtml = loc.thumbnail
                        ? '<img src="' + loc.thumbnail + '" alt="' + loc.name + '" class="marker-popup-image" onerror="this.remove()">'
                        : '';
                    const titleWithDuration = loc.duration
                        ? loc.name + ' (' + loc.duration + ')'
                        : loc.name;
                    const locationContent = '<div class="marker-popup">' +
                        thumbHtml +
                        '<div class="marker-popup-content">' +
                            '<div class="marker-popup-title">' + titleWithDuration + '</div>' +
                            '<a href="../trips/' + dest.slug + '/' + loc.slug + '.html" class="marker-popup-link">Read More \u2192</a>' +
                        '</div>' +
                        '</div>';

                    let locationInfoWindowOpen = false;

                    // Add hover listeners (300ms linger pattern with shared InfoWindow)
                    locationMarker.addListener('mouseover', function() {
                        if (locationHoverTimeout) clearTimeout(locationHoverTimeout);
                        mouseOverLocationInfoWindow = false;
                        locationInfoWindow.setContent(locationContent);
                        locationInfoWindow.open(map, locationMarker);
                        locationInfoWindowOpen = true;
                    });

                    locationMarker.addListener('mouseout', function() {
                        locationHoverTimeout = setTimeout(function() {
                            if (!mouseOverLocationInfoWindow) {
                                locationInfoWindow.close();
                                locationInfoWindowOpen = false;
                            }
                        }, HOVER_LINGER_MS);
                    });

                    // Click navigates to location page
                    locationMarker.addListener('click', function() {
                        // On mobile: first tap opens InfoWindow, second tap navigates
                        if (!locationInfoWindowOpen) {
                            if (locationHoverTimeout) clearTimeout(locationHoverTimeout);
                            mouseOverLocationInfoWindow = false;
                            locationInfoWindow.setContent(locationContent);
                            locationInfoWindow.open(map, locationMarker);
                            locationInfoWindowOpen = true;
                        } else {
                            window.location.href = `../trips/${locationMarker.tripSlug}/${locationMarker.locationSlug}.html`;
                        }
                    });
                });

                // Create polyline (initially hidden)
                const pathCoordinates = dest.locations.map(function(loc) {
                    return loc.coordinates;
                });
                markerSet.polyline = new google.maps.Polyline({
                    path: pathCoordinates,
                    geodesic: true,
                    strokeColor: '#f59e0b',
                    strokeOpacity: 0.8,
                    strokeWeight: 4,
                    map: null,  // Initially not visible
                    icons: [{
                        icon: { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 4 },
                        offset: '0',
                        repeat: '20px'
                    }]
                });
            }

            markerSets.push(markerSet);
        });

        // Add zoom event listener for progressive detail disclosure
        const DETAIL_ZOOM_THRESHOLD = 5;

        map.addListener('zoom_changed', function() {
            const currentZoom = map.getZoom();

            markerSets.forEach(function(markerSet) {
                if (currentZoom >= DETAIL_ZOOM_THRESHOLD) {
                    // High zoom - show detail
                    if (markerSet.tripMarker) {
                        markerSet.tripMarker.setMap(null);  // Hide trip marker
                    }
                    markerSet.locationMarkers.forEach(function(marker) {
                        marker.setMap(map);  // Show location markers
                    });
                    if (markerSet.polyline) {
                        markerSet.polyline.setMap(map);  // Show polyline
                    }
                } else {
                    // Low zoom - show overview
                    if (markerSet.tripMarker) {
                        markerSet.tripMarker.setMap(map);  // Show trip marker
                    }
                    markerSet.locationMarkers.forEach(function(marker) {
                        marker.setMap(null);  // Hide location markers
                    });
                    if (markerSet.polyline) {
                        markerSet.polyline.setMap(null);  // Hide polyline
                    }
                }
            });
        });

        // Set initial state based on current zoom
        google.maps.event.addListenerOnce(map, 'idle', function() {
            google.maps.event.trigger(map, 'zoom_changed');
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMap);
    } else {
        initMap();
    }
</script>
